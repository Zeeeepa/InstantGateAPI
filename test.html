<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstantGate API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 2px; }
    </style>
</head>
<body class="bg-[#0a0a0b] text-zinc-200 min-h-screen">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-56 bg-[#111113] border-r border-zinc-800/50 flex flex-col">
            <div class="p-4 border-b border-zinc-800/50">
                <h1 class="text-base font-semibold text-white">InstantGate</h1>
                <p class="text-[10px] text-zinc-500 mt-0.5">API Explorer</p>
            </div>

            <div class="p-3">
                <p class="text-[10px] text-zinc-500 uppercase tracking-wider mb-2 px-2">Sistem</p>
                <button onclick="testHealth()" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-zinc-800/50 transition-colors">
                    Health
                </button>
                <button onclick="testSchema()" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-zinc-800/50 transition-colors">
                    Schema
                </button>
            </div>

            <div class="p-3 flex-1 overflow-y-auto scrollbar-thin">
                <p class="text-[10px] text-zinc-500 uppercase tracking-wider mb-2 px-2">Tablolar</p>
                <div id="tableList" class="space-y-0.5">
                    <!-- Tablolar buraya gelecek -->
                </div>
            </div>

            <div class="p-3 border-t border-zinc-800/50">
                <div class="flex items-center gap-2 px-2 py-1">
                    <span id="connectionStatus" class="w-2 h-2 rounded-full bg-zinc-600"></span>
                    <span class="text-xs text-zinc-500">Baƒülantƒ± bekleniyor</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Toolbar -->
            <div class="bg-[#111113] border-b border-zinc-800/50 p-3">
                <div class="flex gap-2">
                    <select id="method" class="bg-zinc-900 border border-zinc-700/50 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-zinc-600 w-24">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PATCH">PATCH</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 text-sm">http://localhost:8080</span>
                        <input
                            type="text"
                            id="endpoint"
                            value="/api/api/users"
                            class="w-full bg-zinc-900 border border-zinc-700/50 rounded-lg pl-[165px] pr-4 py-2 text-sm focus:outline-none focus:border-zinc-600"
                        >
                    </div>
                    <button onclick="sendRequest()" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-medium transition-colors">
                        G√∂nder
                    </button>
                </div>

                <!-- Request Body -->
                <div id="bodySection" class="mt-3 hidden">
                    <textarea
                        id="requestBody"
                        placeholder='{ "key": "value" }'
                        class="w-full bg-zinc-900 border border-zinc-700/50 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-zinc-600 font-mono h-24 resize-none scrollbar-thin"
                    ></textarea>
                </div>
            </div>

            <!-- Response Area -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Result Panel -->
                <div class="flex-1 flex flex-col border-r border-zinc-800/50 overflow-hidden">
                    <div class="px-4 py-2 bg-[#111113] border-b border-zinc-800/50 flex items-center justify-between">
                        <span class="text-xs text-zinc-500 uppercase tracking-wider">Sonu√ß</span>
                        <div class="flex items-center gap-3">
                            <span id="responseStatus" class="text-xs text-zinc-500">-</span>
                            <span id="responseTime" class="text-xs text-zinc-600">-</span>
                        </div>
                    </div>
                    <div id="resultPanel" class="flex-1 p-4 overflow-auto scrollbar-thin">
                        <div class="flex items-center justify-center h-full text-zinc-600 text-sm">
                            Bir istek g√∂nderin
                        </div>
                    </div>
                </div>

                <!-- JSON Panel -->
                <div class="w-[420px] flex flex-col overflow-hidden">
                    <div class="px-4 py-2 bg-[#111113] border-b border-zinc-800/50 flex items-center justify-between">
                        <span class="text-xs text-zinc-500 uppercase tracking-wider">JSON Response</span>
                        <button onclick="copyJson()" class="text-xs text-zinc-500 hover:text-zinc-300 transition-colors">
                            Kopyala
                        </button>
                    </div>
                    <pre id="jsonPanel" class="flex-1 p-4 text-xs text-zinc-400 overflow-auto scrollbar-thin font-mono leading-relaxed">-</pre>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API = 'http://localhost:8080';
        let lastJson = null;
        let currentTable = null;
        let tables = []; // Will be loaded dynamically from API

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTablesFromAPI();
            checkConnection();

            document.getElementById('method').addEventListener('change', function() {
                const bodySection = document.getElementById('bodySection');
                bodySection.classList.toggle('hidden', this.value === 'GET' || this.value === 'DELETE');
            });
        });

        async function loadTablesFromAPI() {
            try {
                const res = await fetch(`${API}/api/schema`);
                const data = await res.json();

                if (data.tables && Array.isArray(data.tables)) {
                    // Convert table names to display format
                    tables = data.tables.map(t => ({
                        name: t,
                        label: formatTableName(t)
                    }));
                    renderTableList();
                }
            } catch (e) {
                console.error('Failed to load tables:', e);
                // Show empty state
                document.getElementById('tableList').innerHTML = `
                    <div class="text-xs text-zinc-600 px-2">
                        Tablolar y√ºklenemedi
                    </div>
                `;
            }
        }

        function formatTableName(name) {
            // Convert snake_case or camelCase to readable format
            // e.g., "user_profiles" -> "User Profiles", "userProfiles" -> "User Profiles"
            return name
                .replace(/([A-Z])/g, ' $1')
                .replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ')
                .trim();
        }

        function renderTableList() {
            const container = document.getElementById('tableList');

            if (tables.length === 0) {
                container.innerHTML = `
                    <div class="text-xs text-zinc-600 px-2">
                        Tablo bulunamadƒ±
                    </div>
                `;
                return;
            }

            container.innerHTML = tables.map(t => `
                <button
                    onclick="selectTable('${t.name}')"
                    id="btn-${t.name}"
                    class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-zinc-800/50 transition-colors group"
                >
                    <span class="text-zinc-400 group-hover:text-zinc-200 transition-colors">${t.label}</span>
                </button>
            `).join('');
        }

        function selectTable(name) {
            currentTable = name;

            // Update active state
            tables.forEach(t => {
                const btn = document.getElementById(`btn-${t.name}`);
                if (btn) {
                    if (t.name === name) {
                        btn.classList.add('bg-zinc-800/70');
                        btn.classList.remove('hover:bg-zinc-800/50');
                    } else {
                        btn.classList.remove('bg-zinc-800/70');
                        btn.classList.add('hover:bg-zinc-800/50');
                    }
                }
            });

            document.getElementById('endpoint').value = `/api/api/${name}`;
            document.getElementById('method').value = 'GET';
            document.getElementById('bodySection').classList.add('hidden');
            sendRequest();
        }

        async function checkConnection() {
            try {
                const res = await fetch(`${API}/health`);
                const data = await res.json();
                const statusEl = document.getElementById('connectionStatus');
                const textEl = statusEl.nextElementSibling;

                if (data.status === 'ok') {
                    statusEl.className = 'w-2 h-2 rounded-full bg-emerald-500';
                    textEl.textContent = 'Baƒülƒ±';
                    textEl.className = 'text-xs text-emerald-500';
                } else {
                    statusEl.className = 'w-2 h-2 rounded-full bg-amber-500';
                    textEl.textContent = 'Kƒ±smi baƒülantƒ±';
                }
            } catch (e) {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.className = 'w-2 h-2 rounded-full bg-red-500';
                statusEl.nextElementSibling.textContent = 'Baƒülantƒ± yok';
            }
        }

        async function sendRequest() {
            const endpoint = document.getElementById('endpoint').value;
            const method = document.getElementById('method').value;
            const body = document.getElementById('requestBody').value;

            const start = Date.now();

            try {
                const options = { method };
                if (body && (method === 'POST' || method === 'PATCH')) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = body;
                }

                const res = await fetch(API + endpoint, options);
                const data = await res.json();
                const ms = Date.now() - start;

                // Update status
                document.getElementById('responseStatus').innerHTML = `
                    <span class="${res.ok ? 'text-emerald-500' : 'text-red-400'}">${res.status} ${res.statusText}</span>
                `;
                document.getElementById('responseTime').textContent = `${ms}ms`;

                // Show JSON
                lastJson = JSON.stringify(data, null, 2);
                document.getElementById('jsonPanel').textContent = lastJson;

                // Render result
                renderResult(data, endpoint);

            } catch (e) {
                document.getElementById('responseStatus').innerHTML = '<span class="text-red-400">Baƒülantƒ± hatasƒ±</span>';
                document.getElementById('resultPanel').innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="text-red-400 text-4xl mb-3">‚ö†Ô∏è</div>
                            <p class="text-zinc-400">Sunucuya baƒülanƒ±lamadƒ±</p>
                            <p class="text-zinc-600 text-sm mt-1">API'nin √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun</p>
                        </div>
                    </div>
                `;
            }
        }

        function renderResult(data, endpoint) {
            const panel = document.getElementById('resultPanel');

            // Schema response - reload tables dynamically
            if (data.tables && Array.isArray(data.tables)) {
                // Update tables array
                tables = data.tables.map(t => ({
                    name: t,
                    label: formatTableName(t)
                }));
                renderTableList();

                panel.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-white">${data.count} Tablo</h3>
                        <p class="text-sm text-zinc-500">Veritabanƒ±ndaki t√ºm tablolar</p>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        ${tables.map(t => `
                            <button
                                onclick="selectTable('${t.name}')"
                                class="p-3 bg-zinc-800/30 hover:bg-zinc-800/60 rounded-lg text-left transition-colors border border-zinc-700/30"
                            >
                                <p class="text-sm text-zinc-300">${t.label}</p>
                            </button>
                        `).join('')}
                    </div>
                `;
                return;
            }

            // List response
            if (data.data && Array.isArray(data.data)) {
                if (data.data.length === 0) {
                    panel.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <div class="text-zinc-600 text-4xl mb-3">üì≠</div>
                                <p class="text-zinc-400">Kayƒ±t bulunamadƒ±</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const keys = Object.keys(data.data[0]);
                const visibleKeys = keys.slice(0, 6);

                panel.innerHTML = `
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-white">${data.pagination?.total || data.data.length} Kayƒ±t</h3>
                            <p class="text-sm text-zinc-500">${visibleKeys.length}/${keys.length} kolon g√∂steriliyor</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="prevPage()" class="px-3 py-1 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">‚Üê</button>
                            <span class="px-3 py-1 text-sm text-zinc-400">
                                ${Math.floor((data.pagination?.offset || 0) / (data.pagination?.limit || 50)) + 1}
                            </span>
                            <button onclick="nextPage()" class="px-3 py-1 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">‚Üí</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-zinc-700/50">
                                    ${visibleKeys.map(k => `
                                        <th class="text-left py-2 px-3 text-xs text-zinc-500 font-medium uppercase tracking-wider">${k}</th>
                                    `).join('')}
                                    <th class="w-20"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(row => `
                                    <tr class="border-b border-zinc-800/50 hover:bg-zinc-800/20 transition-colors">
                                        ${visibleKeys.map(k => {
                                            let val = row[k];
                                            if (val === null) val = '<span class="text-zinc-600">null</span>';
                                            else if (typeof val === 'boolean') val = val ? '‚úì' : '‚úó';
                                            else if (typeof val === 'string' && val.length > 30) val = val.substring(0, 30) + '...';
                                            return `<td class="py-2.5 px-3 text-sm">${val}</td>`;
                                        }).join('')}
                                        <td class="py-2.5 px-3">
                                            <button
                                                onclick="viewRecord(${row.Id || row.id})"
                                                class="text-xs text-zinc-500 hover:text-zinc-300 transition-colors"
                                            >Detay</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                return;
            }

            // Single record
            if (data && typeof data === 'object' && !data.error) {
                const keys = Object.keys(data);
                panel.innerHTML = `
                    <div class="max-w-lg">
                        <div class="mb-4">
                            <h3 class="text-lg font-medium text-white">Kayƒ±t Detayƒ±</h3>
                            <p class="text-sm text-zinc-500">${keys.length} alan</p>
                        </div>
                        <div class="space-y-1">
                            ${keys.map(k => {
                                let val = data[k];
                                let valClass = 'text-zinc-200';

                                if (val === null) {
                                    val = 'null';
                                    valClass = 'text-zinc-600 italic';
                                } else if (typeof val === 'boolean') {
                                    val = val ? '‚úì Evet' : '‚úó Hayƒ±r';
                                    valClass = val.includes('Evet') ? 'text-emerald-400' : 'text-zinc-400';
                                } else if (typeof val === 'number') {
                                    valClass = 'text-amber-400';
                                } else if (typeof val === 'string' && val.match(/^\d{4}-\d{2}-\d{2}/)) {
                                    valClass = 'text-blue-400';
                                }

                                return `
                                    <div class="flex py-2 border-b border-zinc-800/50">
                                        <span class="w-40 text-sm text-zinc-500 shrink-0">${k}</span>
                                        <span class="text-sm ${valClass} break-all">${val}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                return;
            }

            // Error or other
            panel.innerHTML = `
                <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4">
                    <p class="text-red-400 font-medium">${data.error || 'Hata'}</p>
                    <p class="text-zinc-400 text-sm mt-1">${data.message || ''}</p>
                </div>
            `;
        }

        function viewRecord(id) {
            if (!currentTable) return;
            document.getElementById('endpoint').value = `/api/api/${currentTable}/${id}`;
            sendRequest();
        }

        function prevPage() {
            const endpoint = document.getElementById('endpoint').value;
            const url = new URL(API + endpoint);
            const offset = parseInt(url.searchParams.get('offset') || '0');
            const limit = parseInt(url.searchParams.get('limit') || '50');

            if (offset > 0) {
                url.searchParams.set('offset', Math.max(0, offset - limit));
                document.getElementById('endpoint').value = url.pathname + url.search;
                sendRequest();
            }
        }

        function nextPage() {
            const endpoint = document.getElementById('endpoint').value;
            const url = new URL(API + endpoint);
            const offset = parseInt(url.searchParams.get('offset') || '0');
            const limit = parseInt(url.searchParams.get('limit') || '50');

            url.searchParams.set('offset', offset + limit);
            document.getElementById('endpoint').value = url.pathname + url.search;
            sendRequest();
        }

        function copyJson() {
            if (lastJson) {
                navigator.clipboard.writeText(lastJson);
                const btn = event.target;
                btn.textContent = 'Kopyalandƒ±!';
                setTimeout(() => btn.textContent = 'Kopyala', 1500);
            }
        }

        async function testHealth() {
            document.getElementById('endpoint').value = '/health';
            document.getElementById('method').value = 'GET';
            await sendRequest();
        }

        async function testSchema() {
            document.getElementById('endpoint').value = '/api/schema';
            document.getElementById('method').value = 'GET';
            await sendRequest();
        }
    </script>
</body>
</html>
